<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- FIXED: Add iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üçΩÔ∏è AR Restaurant Menu</title>

    <!-- FIXED: Use correct AR.js version -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
        }

        /* Enhanced Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-screen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .loading-logo {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* Enhanced AR UI Elements */
        .ar-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .ar-ui * {
            pointer-events: auto;
        }

        /* Enhanced Menu Container */
        .menu-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 30px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .menu-container.visible {
            display: flex;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .menu-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .menu-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .menu-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 300;
        }

        /* Search Bar */
        .search-container {
            width: 100%;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-input:focus {
            outline: none;
            border-color: #4ecdc4;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
        }

        /* Enhanced Menu Items */
        .menu-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
        }

        .menu-items::-webkit-scrollbar {
            width: 6px;
        }

        .menu-items::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .menu-items::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .menu-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .menu-item:hover::before {
            left: 100%;
        }

        .menu-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .menu-item:active {
            transform: translateY(0) scale(0.98);
        }

        .menu-item-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dish-info {
            flex: 1;
        }

        .dish-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #fff;
        }

        .dish-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .dish-price {
            font-size: 20px;
            font-weight: 700;
            color: #4ecdc4;
        }

        .dish-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .favorite-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
        }

        .favorite-btn:hover {
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .favorite-btn.active {
            color: #ff6b6b;
        }

        .view-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        /* Enhanced Dish View */
        .dish-view {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 35px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            min-width: 350px;
            max-width: 90vw;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dish-view.visible {
            display: flex;
        }

        .dish-view-header {
            text-align: center;
            width: 100%;
        }

        .dish-view-name {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dish-view-description {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .dish-view-price {
            font-size: 28px;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 20px;
        }

        .dish-view-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Enhanced Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Enhanced Instructions */
        .instructions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px 25px;
            text-align: center;
            font-size: 14px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Enhanced Error Messages */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            display: none;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.3);
            animation: shake 0.5s ease;
        }

        .error-message.visible {
            display: block;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(-50%, -50%);
            }

            25% {
                transform: translate(-52%, -50%);
            }

            75% {
                transform: translate(-48%, -50%);
            }
        }

        /* Enhanced Camera Permission Prompt */
        .camera-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            display: none;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .camera-prompt.visible {
            display: block;
        }

        .camera-prompt h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .camera-prompt p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.8);
        }

        .camera-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            z-index: 200;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4ecdc4;
        }

        /* Responsive Design */
        @media (max-width: 768px) {

            .menu-container,
            .dish-view {
                min-width: 280px;
                padding: 20px;
            }

            .menu-title {
                font-size: 24px;
            }

            .dish-view-name {
                font-size: 26px;
            }

            .instructions {
                bottom: 20px;
                padding: 12px 20px;
                font-size: 13px;
            }
        }

        /* Loading Animation for Models */
        .model-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            display: none;
        }

        .model-loading.visible {
            display: block;
        }

        /* Favorites Counter */
        .favorites-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 107, 107, 0.9);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            display: none;
            z-index: 200;
        }

        .favorites-counter.visible {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Enhanced Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üçΩÔ∏è</div>
        <div class="spinner"></div>
        <div class="loading-text">Loading AR Restaurant Menu...</div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Initializing...</span>
    </div>

    <!-- Favorites Counter -->
    <div class="favorites-counter" id="favoritesCounter">
        <i class="fas fa-heart"></i>
        <span id="favoritesCount">0</span> Favorites
    </div>

    <!-- Enhanced Camera Permission Prompt -->
    <div class="camera-prompt" id="cameraPrompt">
        <h3><i class="fas fa-camera"></i> Camera Access Required</h3>
        <p>This AR experience needs camera access to create an immersive dining experience. Please allow camera
            permissions to continue.</p>
        <button class="camera-btn" onclick="requestCameraAccess()">
            <i class="fas fa-camera"></i> Enable Camera
        </button>
    </div>

    <!-- Enhanced Error Message -->
    <div class="error-message" id="errorMessage">
        <div id="errorText"></div>
    </div>

    <!-- Model Loading Indicator -->
    <div class="model-loading" id="modelLoading">
        <div class="spinner"></div>
        <div>Loading 3D Model...</div>
    </div>

    <!-- AR UI -->
    <div class="ar-ui">
        <!-- Enhanced Menu Container -->
        <div class="menu-container" id="menuContainer">
            <div class="menu-header">
                <div class="menu-title">üçΩÔ∏è AR Restaurant</div>
                <div class="menu-subtitle">Point your camera at the Hiro marker</div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search dishes...">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="menu-items" id="menuItems">
                <!-- Menu items will be populated here -->
            </div>
        </div>

        <!-- Enhanced Dish View -->
        <div class="dish-view" id="dishView">
            <div class="dish-view-header">
                <div class="dish-view-name" id="dishViewName"></div>
                <div class="dish-view-description" id="dishViewDescription"></div>
                <div class="dish-view-price" id="dishViewPrice"></div>
            </div>

            <div class="dish-view-actions">
                <button class="btn btn-primary" onclick="addToFavorites()">
                    <i class="fas fa-heart"></i> Add to Favorites
                </button>
                <button class="btn btn-secondary" onclick="showMenu()">
                    <i class="fas fa-arrow-left"></i> Back to Menu
                </button>
            </div>
        </div>

        <!-- Enhanced Instructions -->
        <div class="instructions">
            <i class="fas fa-info-circle"></i>
            Point your camera at the Hiro marker to see the interactive menu
            <br>
            <button onclick="testModelLoading()"
                style="margin-top: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; border-radius: 5px; font-size: 12px;">
                Test 3D Models
            </button>
        </div>
    </div>

    <!-- FIXED: Corrected AR scene configuration -->
    <a-scene vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true;" embedded>

        <!-- Hiro Marker -->
        <a-marker preset="hiro" id="hiroMarker">
            <!-- 3D models will be loaded here when dishes are selected -->
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Enhanced Global variables
        let menuData = [];
        let currentDish = null;
        let modelsLoaded = new Set();
        let favorites = JSON.parse(localStorage.getItem('arMenuFavorites') || '[]');
        let filteredMenuData = [];

        // Enhanced Configuration
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/YOUR_ID?sheet=menu'; // Replace with your SheetDB.io URL

        // Enhanced sample menu data with descriptions
        const FALLBACK_MENU = [
            {
                name: "Classic Burger",
                price: 12.99,
                model: "burger.glb", // Maps to ./assets/glb/burger.glb
                description: "Juicy beef patty with fresh lettuce, tomatoes, and special sauce",
                category: "main",
                prepTime: "15 min"
            },
            {
                name: "Margherita Pizza",
                price: 15.99,
                model: "pizza.glb", // Maps to ./assets/glb/pizza.glb
                description: "Traditional Italian pizza with mozzarella, basil, and tomato sauce",
                category: "main",
                prepTime: "20 min"
            },
            {
                name: "Fresh Garden Salad",
                price: 8.99,
                model: "salad.glb",
                description: "Crispy mixed greens with cherry tomatoes and balsamic dressing",
                category: "appetizer",
                prepTime: "8 min"
            },
            {
                name: "Chocolate Cake",
                price: 6.99,
                model: "cake.glb",
                description: "Rich chocolate cake with vanilla ice cream",
                category: "dessert",
                prepTime: "5 min"
            },
            {
                name: "Iced Latte",
                price: 4.99,
                model: "coffee.glb",
                description: "Smooth espresso with cold milk and ice",
                category: "beverage",
                prepTime: "3 min"
            }
        ];

        // FIXED: Simplified and corrected initialization
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize AR
            const scene = document.querySelector('a-scene');
            const marker = document.getElementById('hiroMarker');

            // Add marker detection events
            marker.addEventListener('markerFound', () => {
                console.log('Marker found!');
                updateStatus('Marker detected - Menu active', true);
                showMenu();
            });

            marker.addEventListener('markerLost', () => {
                console.log('Marker lost');
                updateStatus('Point at Hiro marker', false);
                hideMenu();
                hideDishView();
            });

            // Request camera access
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    hideCameraPrompt();
                    hideLoading();
                    updateStatus('Camera connected', true);
                    // Stop tracks since AR.js handles camera
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(err => {
                    console.error('Camera error:', err);
                    updateStatus('Camera access denied', false);
                    showCameraPrompt();
                });

            // Load menu data and populate
            loadMenuData();
            setupSearch();
            updateFavoritesCounter();

            // Hide loading after a short delay
            setTimeout(() => {
                hideLoading();
            }, 2000);
        });

        // Enhanced menu data loading
        async function loadMenuData() {
            updateStatus('Loading menu data...', false);

            try {
                const response = await fetch(SHEETDB_URL);
                if (response.ok) {
                    menuData = await response.json();
                    console.log('Menu data loaded from API:', menuData);
                } else {
                    throw new Error('Failed to fetch menu data');
                }
            } catch (error) {
                console.warn('Using fallback menu data:', error);
                menuData = FALLBACK_MENU;
            }

            // Ensure we have at least 3 items
            while (menuData.length < 3) {
                menuData.push(FALLBACK_MENU[menuData.length]);
            }

            // Add default values for missing fields
            menuData = menuData.map(item => ({
                description: item.description || 'Delicious dish prepared with fresh ingredients',
                category: item.category || 'main',
                prepTime: item.prepTime || '15 min',
                ...item
            }));

            filteredMenuData = [...menuData];
            updateStatus('Menu loaded successfully', true);
        }

        // Enhanced search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');

            searchInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();

                if (searchTerm === '') {
                    filteredMenuData = [...menuData];
                } else {
                    filteredMenuData = menuData.filter(dish =>
                        dish.name.toLowerCase().includes(searchTerm) ||
                        dish.description.toLowerCase().includes(searchTerm) ||
                        dish.category.toLowerCase().includes(searchTerm)
                    );
                }

                if (document.getElementById('menuContainer').classList.contains('visible')) {
                    populateMenu();
                }
            });
        }

        // Enhanced menu display
        function showMenu() {
            hideDishView();
            populateMenu();
            document.getElementById('menuContainer').classList.add('visible');
        }

        // Enhanced menu hiding
        function hideMenu() {
            document.getElementById('menuContainer').classList.remove('visible');
        }

        // Enhanced menu population
        function populateMenu() {
            const menuItems = document.getElementById('menuItems');
            menuItems.innerHTML = '';

            if (filteredMenuData.length === 0) {
                menuItems.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>No dishes found matching your search</div>
                    </div>
                `;
                return;
            }

            filteredMenuData.forEach((dish, index) => {
                const isFavorite = favorites.some(fav => fav.name === dish.name);

                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';

                menuItem.innerHTML = `
                    <div class="menu-item-content">
                        <div class="dish-info">
                            <div class="dish-name">${dish.name}</div>
                            <div class="dish-description">${dish.description}</div>
                            <div class="dish-price">$${dish.price}</div>
                        </div>
                        <div class="dish-actions">
                            <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(event, '${dish.name}')">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="view-btn" onclick="selectDish('${dish.name}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                `;

                menuItems.appendChild(menuItem);
            });
        }

        // Enhanced dish selection
        function selectDish(dishName) {
            const dish = filteredMenuData.find(d => d.name === dishName);
            if (!dish) return;

            currentDish = dish;
            hideMenu();
            showDishView(dish);
            loadDishModel(dish);
        }

        // Enhanced dish view display
        function showDishView(dish) {
            document.getElementById('dishViewName').textContent = dish.name;
            document.getElementById('dishViewDescription').textContent = dish.description;
            document.getElementById('dishViewPrice').textContent = `$${dish.price}`;
            document.getElementById('dishView').classList.add('visible');
        }

        // Enhanced dish view hiding
        function hideDishView() {
            document.getElementById('dishView').classList.remove('visible');
        }

        // Enhanced 3D model loading
        function loadDishModel(dish) {
            const marker = document.getElementById('hiroMarker');
            const modelLoading = document.getElementById('modelLoading');

            console.log('Loading model for:', dish.name, 'Model URL:', getModelUrl(dish.model));

            // Show loading indicator
            modelLoading.classList.add('visible');

            // Remove existing model
            const existingModel = marker.querySelector('.dish-model');
            if (existingModel) {
                existingModel.remove();
            }

            // Create new model entity
            const modelEntity = document.createElement('a-entity');
            modelEntity.className = 'dish-model';
            modelEntity.setAttribute('gltf-model', getModelUrl(dish.model));
            modelEntity.setAttribute('position', '0 0.5 0');
            modelEntity.setAttribute('scale', '0.5 0.5 0.5');
            modelEntity.setAttribute('rotation', '0 0 0');

            // Add enhanced animation
            modelEntity.setAttribute('animation', {
                property: 'rotation',
                to: '0 360 0',
                dur: 15000,
                loop: true,
                easing: 'linear'
            });

            // Add hover animation
            modelEntity.setAttribute('animation__hover', {
                property: 'scale',
                to: '0.6 0.6 0.6',
                dur: 1000,
                easing: 'easeInOutQuad',
                startEvents: 'mouseenter',
                pauseEvents: 'mouseleave'
            });

            marker.appendChild(modelEntity);

            // Hide loading indicator after model loads - using correct A-Frame event names
            modelEntity.addEventListener('model-loaded', function () {
                console.log('Model loaded successfully:', dish.name);
                modelLoading.classList.remove('visible');
                modelsLoaded.add(dish.model);
            });

            // Handle model loading errors - using correct A-Frame event names
            modelEntity.addEventListener('model-error', function (error) {
                console.error('Model loading error:', error);
                modelLoading.classList.remove('visible');
                showError('Failed to load 3D model: ' + dish.name);
            });

            // Alternative event listeners for different A-Frame versions
            modelEntity.addEventListener('loaded', function () {
                console.log('Model loaded (alternative event):', dish.name);
                modelLoading.classList.remove('visible');
                modelsLoaded.add(dish.model);
            });

            // Add timeout to hide loading if model doesn't load
            setTimeout(() => {
                if (modelLoading.classList.contains('visible')) {
                    console.warn('Model loading timeout:', dish.name);
                    modelLoading.classList.remove('visible');
                }
            }, 10000); // 10 second timeout
        }

        // Enhanced model URL mapping - Using local GLB files
        function getModelUrl(modelName) {
            // Use local GLB files from assets/glb directory
            const modelMap = {
                'burger.glb': './assets/glb/burge.glb', // Using the actual filename you have
                'pizza.glb': './assets/glb/pizza.glb',
                // 'salad.glb': './assets/glb/salad.glb', // Fallback if you add this later
                // 'cake.glb': './assets/glb/cake.glb',   // Fallback if you add this later
                // 'coffee.glb': './assets/glb/coffee.glb' // Fallback if you add this later
            };

            // Return local path if available, otherwise fallback to external
            if (modelMap[modelName]) {
                return modelMap[modelName];
            }

            // Fallback to external models for any missing local files
            const externalModelMap = {
                'salad.glb': 'https://poly.pizza/api/v1/models/salad.glb',
                'cake.glb': 'https://poly.pizza/api/v1/models/cake.glb',
                'coffee.glb': 'https://poly.pizza/api/v1/models/coffee.glb'
            };

            return externalModelMap[modelName] || modelName;
        }

        // Enhanced favorites functionality
        function toggleFavorite(event, dishName) {
            event.stopPropagation();

            const dish = menuData.find(d => d.name === dishName);
            if (!dish) return;

            const index = favorites.findIndex(fav => fav.name === dishName);

            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(dish);
            }

            localStorage.setItem('arMenuFavorites', JSON.stringify(favorites));
            updateFavoritesCounter();

            // Update UI
            const btn = event.target.closest('.favorite-btn');
            btn.classList.toggle('active');
        }

        function addToFavorites() {
            if (!currentDish) return;

            const index = favorites.findIndex(fav => fav.name === currentDish.name);

            if (index === -1) {
                favorites.push(currentDish);
                localStorage.setItem('arMenuFavorites', JSON.stringify(favorites));
                updateFavoritesCounter();
                showMessage('Added to favorites!');
            } else {
                showMessage('Already in favorites!');
            }
        }

        function updateFavoritesCounter() {
            const counter = document.getElementById('favoritesCounter');
            const count = document.getElementById('favoritesCount');

            count.textContent = favorites.length;

            if (favorites.length > 0) {
                counter.classList.add('visible');
            } else {
                counter.classList.remove('visible');
            }
        }

        // Enhanced status updates
        function updateStatus(message, isConnected) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');

            statusText.textContent = message;

            if (isConnected) {
                statusIndicator.classList.add('connected');
            } else {
                statusIndicator.classList.remove('connected');
            }
        }

        // Enhanced UI Helper Functions
        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showCameraPrompt() {
            document.getElementById('cameraPrompt').classList.add('visible');
        }

        function hideCameraPrompt() {
            document.getElementById('cameraPrompt').classList.remove('visible');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.add('visible');

            setTimeout(() => {
                document.getElementById('errorMessage').classList.remove('visible');
            }, 5000);
        }

        function showMessage(message) {
            // Create temporary message
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(78, 205, 196, 0.9);
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                font-weight: 600;
                z-index: 1000;
                animation: fadeInOut 2s ease;
            `;
            msg.textContent = message;

            document.body.appendChild(msg);

            setTimeout(() => {
                document.body.removeChild(msg);
            }, 2000);
        }

        // Add fadeInOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Enhanced event handlers
        window.addEventListener('resize', function () {
            // Adjust UI elements if needed
        });

        window.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                hideMenu();
                hideDishView();
            }
        });

        // Handle back button
        window.addEventListener('popstate', function () {
            if (document.getElementById('dishView').classList.contains('visible')) {
                showMenu();
            }
        });

        // Enhanced touch interactions
        document.addEventListener('touchstart', function () { }, { passive: true });
        document.addEventListener('touchmove', function () { }, { passive: true });

        // FIXED: Basic test functions
        function requestCameraAccess() {
            location.reload(); // Simplest way to re-trigger permission
        }

        // Test function to verify GLB files are accessible
        function testGLBFiles() {
            console.log('Testing GLB file accessibility...');

            const testFiles = [
                './assets/glb/burge.glb',
                './assets/glb/pizza.glb'
            ];

            testFiles.forEach(url => {
                fetch(url, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            console.log('‚úÖ GLB file accessible:', url);
                        } else {
                            console.error('‚ùå GLB file not found:', url);
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå GLB file error:', url, error);
                    });
            });
        }

        // Test 3D model loading manually
        function testModelLoading() {
            console.log('Testing 3D model loading...');
            const testDish = {
                name: "Test Burger",
                model: "burger.glb"
            };
            loadDishModel(testDish);
        }

        // Test GLB files on page load
        window.addEventListener('load', function () {
            setTimeout(testGLBFiles, 1000); // Test after 1 second
        });
    </script>

    <!-- 
    ENHANCED SETUP INSTRUCTIONS:
    
    1. Replace 'YOUR_ID' in SHEETDB_URL with your actual SheetDB.io API ID
    2. Create a Google Sheet with columns: name, price, model, description, category, prepTime
    3. Set up SheetDB.io to connect to your Google Sheet
    4. Print the Hiro marker: https://jeromeetienne.github.io/AR.js/data/images/HIRO.jpg
    5. Host this HTML file on a web server (HTTPS required for camera access)
    6. Generate a QR code pointing to your hosted HTML file
    7. Test by scanning QR code and pointing camera at Hiro marker
    
    LOCAL 3D MODELS:
    ‚úÖ burger.glb ‚Üí ./assets/glb/burge.glb (2.4MB)
    ‚úÖ pizza.glb ‚Üí ./assets/glb/pizza.glb (6.9MB)
    
    To add more models:
    1. Place GLB files in ./assets/glb/ directory
    2. Update the modelMap in getModelUrl() function
    3. Add corresponding menu items in your Google Sheet
    
    FIXES APPLIED:
    ‚úÖ iOS-specific meta tags for better mobile experience
    ‚úÖ Correct AR.js version (raw.githack.com instead of jsdelivr)
    ‚úÖ Simplified A-Frame scene configuration
    ‚úÖ Reliable camera access handling
    ‚úÖ Correct local GLB file paths
    ‚úÖ Simplified initialization for better compatibility
    
    GOOGLE SHEETS FORMAT:
    | name | price | model | description | category | prepTime |
    |------|-------|-------|-------------|----------|----------|
    | Burger | 12.99 | burger.glb | Juicy beef patty... | main | 15 min |
    | Pizza | 15.99 | pizza.glb | Traditional Italian... | main | 20 min |
    | Salad | 8.99 | salad.glb | Crispy mixed greens... | appetizer | 8 min |
    
    NEW FEATURES:
    ‚úÖ Enhanced UI with gradients and animations
    ‚úÖ Search functionality
    ‚úÖ Favorites system with local storage
    ‚úÖ Better error handling and status indicators
    ‚úÖ Improved 3D model loading with progress indicators
    ‚úÖ Responsive design for all devices
    ‚úÖ Enhanced accessibility and touch interactions
    ‚úÖ Better visual feedback and animations
    ‚úÖ Status bar showing connection status
    ‚úÖ More detailed dish information
    ‚úÖ Local GLB file support for faster loading
    
    TROUBLESHOOTING:
    - Ensure HTTPS for camera access
    - Check browser console for errors
    - Test on mobile device for best AR experience
    - Ensure good lighting for marker detection
    - Clear browser cache if experiencing issues
    - Verify GLB files are accessible at ./assets/glb/ path
    - If camera doesn't work, try refreshing the page
    -->
</body>

</html>